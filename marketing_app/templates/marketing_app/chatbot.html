{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Marketing Chatbot</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    body {
      background: #e9ecef;
      font-family: 'Helvetica Neue', Arial, sans-serif;
    }
    .chat-container {
      max-width: 800px;
      margin: 30px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .chat-header {
      background: #007bff;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
    }
    .chat-body {
      height: 400px;
      overflow-y: auto;
      padding: 20px;
      background: #f8f9fa;
    }
    .message {
      margin-bottom: 15px;
      display: flex;
    }
    .message.user .bubble {
      background: #dcf8c6;
      border-radius: 10px 10px 0 10px;
      margin-left: auto;
    }
    .message.bot .bubble {
      background: #fff;
      border-radius: 10px 10px 10px 0;
      margin-right: auto;
    }
    .bubble {
      padding: 10px 15px;
      max-width: 70%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .chat-footer {
      padding: 20px;
      background: #fff;
      border-top: 1px solid #dee2e6;
    }
    .upload-area {
      border: 2px dashed #007bff;
      border-radius: 5px;
      padding: 15px;
      text-align: center;
      color: #6c757d;
      margin-bottom: 15px;
      background: #f1f9ff;
      transition: background 0.3s ease;
    }
    .upload-area:hover {
      background: #e8f0fe;
    }
    .btn-submit {
      background-color: #007bff;
      border: none;
    }
    .btn-submit:hover {
      background-color: #0056b3;
    }
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #007bff;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: none;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="{% url 'dashboard' %}">Marketing ML Dashboard</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarNav" aria-controls="navbarNav"
              aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" href="{% url 'dashboard' %}">Accueil</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Analyse Prédictive</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Campagnes Personnalisées</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Sentiments Réseaux Sociaux</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'chatbot' %}">Chatbot</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Chat Container -->
  <div class="container my-4">
    <div class="chat-container">
      <div class="chat-header">
        Marketing Chatbot
      </div>
      <div class="chat-body" id="chatBody">
        <!-- Historique de la conversation -->
        {% if chat_history %}
          {% for msg in chat_history %}
            <div class="message {% if msg.sender == 'user' %}user{% else %}bot{% endif %}">
              <div class="bubble">
                {{ msg.content }}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="text-center text-muted">No conversation yet. Start by sending a message!</p>
        {% endif %}
      </div>
      <!-- Loader Spinner -->
      <div class="loader" id="loader"></div>
      <div class="chat-footer">
        <form id="chatForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">
            <textarea class="form-control" id="message" name="message" rows="2" placeholder="Type your message here..."></textarea>
          </div>
          <div class="mb-3 upload-area">
            <label for="fileUpload" class="form-label">Attach a file (CSV, PDF, Excel, etc.)</label>
            <input type="file" class="form-control" id="fileUpload" name="uploaded_file" accept=".csv,.pdf,.xls,.xlsx,application/pdf">
            <div id="fileName" class="mt-2 text-muted"></div>
          </div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg btn-submit">Send</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast Notification for file upload -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="uploadToast" class="toast align-items-center text-bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          File selected: <span id="toastFileName"></span>
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery (pour AJAX) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Custom JavaScript -->
  <script>
    // Auto-scroll de la zone de chat vers le bas
    function scrollChatToBottom() {
      var chatBody = document.getElementById("chatBody");
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    scrollChatToBottom();

    // Loader spinner
    function showLoader() {
      document.getElementById('loader').style.display = 'block';
    }
    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }

    // Affichage du nom du fichier uploadé et notification toast
    const fileUploadInput = document.getElementById('fileUpload');
    const fileNameDisplay = document.getElementById('fileName');
    const toastFileName = document.getElementById('toastFileName');
    const uploadToastElement = document.getElementById('uploadToast');
    const uploadToast = new bootstrap.Toast(uploadToastElement);
    fileUploadInput.addEventListener('change', function() {
      if (this.files && this.files[0]) {
        fileNameDisplay.textContent = "File selected: " + this.files[0].name;
        toastFileName.textContent = this.files[0].name;
        uploadToast.show();
      } else {
        fileNameDisplay.textContent = "";
      }
    });

    // Soumission du formulaire via AJAX pour mise à jour du chat
    $("#chatForm").submit(function(e) {
      e.preventDefault();
      showLoader();
      var formData = new FormData(this);
      $.ajax({
        url: "{% url 'chatbot' %}",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function(data) {
          // Ajouter les messages utilisateur et bot à l'historique
          $("#chatBody").append(
            `<div class="message user"><div class="bubble">${$("#message").val()}</div></div>` +
            `<div class="message bot"><div class="bubble">${data.response}</div></div>`
          );
          $("#message").val('');
          $("#fileUpload").val('');
          fileNameDisplay.textContent = "";
          scrollChatToBottom();
          hideLoader();
        },
        error: function(xhr, status, error) {
          alert("Une erreur est survenue lors de l'envoi du message.");
          hideLoader();
        }
      });
    });

    // Simulation d'actualisation dynamique des KPI toutes les 15 secondes
    setInterval(function() {
      $.ajax({
        url: "{% url 'get_kpi' %}", // Créez cette URL dans vos vues pour renvoyer des données KPI en JSON
        type: "GET",
        success: function(data) {
          $("#kpiValue").text(data.kpi_value);
        }
      });
    }, 15000);
    
    // Exemple d'actualisation dynamique des graphiques (à adapter selon vos données réelles)
    function updateCharts() {
      // Code pour mettre à jour les graphiques si besoin
      // Par exemple, vous pourriez récupérer de nouvelles données via AJAX et mettre à jour Chart.js
    }
    setInterval(updateCharts, 20000); // Mettre à jour toutes les 20 secondes
  </script>
</body>
</html>
